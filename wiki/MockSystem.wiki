== Mocking system classes ==

=== Quick summary ===

  # Use the `@RunWith(PowerMockRunner.class)` annotation at the class-level of the test case.
  # Use the `@PrepareForTest({ClassThatCallsTheSystemClass.class, YourTest.class})` annotation at the class-level of the test case.
  # Use `mockStatic(SystemClass.class)` to mock the system class then setup the expectations as normally.
  # Use `PowerMock.replayAll()` to change to replay mode.
  # Use `PowerMock.verifyAll()` to change to verify mode.

Note: At the moment this only works for *non-final* system classes.

=== Example ===

PowerMock 1.2 and above supports mocking static methods in Java system classes such as those located in java.lang and java.net etc if they are not final (support for final classes may be supported in the future as well). This works without modifying your JVM or IDE settings! The way to go about mocking these classes are a bit different than usual though. Normally you would prepare the class that contains the static methods (let's call it X) you like to mock but because it's impossible for PowerMock to prepare a system class for testing another approach has to be taken. So instead of preparing X you prepare the class that calls the static methods in X _and_ the test case! Let's look at a simple example:


{{{
public class SystemClassUser {

	public String performEncode() throws UnsupportedEncodingException {
		return URLEncoder.encode("string", "enc");
	}
}
}}}

Here we'd like to mock the static method call to `java.net.URLEncoder#encode(..)` which is normally not possible. Since the URLEncoder class is a system class we should prepare the `SystemClassUser` for test since this is the class calling the encode method of the `URLEncoder`. But this is not enough because in order for our expectations to work we must also prepare the actual test. I.e. 
{{{
@RunWith(PowerMockRunner.class)
@PrepareForTest( { SystemClassUser.class, SystemClassUserTest.class })
public class SystemClassUserTest {

	@Test
	public void assertThatMockingOfNonFinalSystemClassesWorks() throws Exception {
		mockStatic(URLEncoder.class);

		expect(URLEncoder.encode("string", "enc")).andReturn("something");
		replayAll();

		assertEquals("something", new SystemClassUser().performEncode());

		verifyAll();
	}
}
}}}


=== References === 
  * [http://code.google.com/p/powermock/source/browse/trunk/modules/module-test/powermock/junit4-test/src/test/java/samples/junit4/system/SystemClassUserTest.java SystemClassUserTest]
  * [http://code.google.com/p/powermock/source/browse/trunk/tests/utils/src/main/java/samples/system/SystemClassUser.java SystemClassUser]